<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>일간차트</title>
    <script>
      function getYesterdayDateString() {
        const d = new Date();
        d.setDate(d.getDate() - 1);
        return d.toISOString().slice(0, 10); // yyyy-MM-dd
      }
      async function fetchChart() {
        const date = document.getElementById("chartDate").value;
        if(!date) return;

        const response = await fetch(`/api/chart/daily?date=${date}`);
        const data = await response.json();

        const tbody = document.getElementById("chartBody");
        tbody.innerHTML = "";

        data.forEach(song => {
          const row = `<tr>
                    <td>${song.chartRank}</td>
                    <td>${song.title}</td>
                    <td>${song.artist}</td>
                    <td>${song.playCount}</td>
                    <td>
                      <button onclick="playMusic(${song.musicId}, '${song.youtubeUrl}')">▶️ 재생</button>
                    </td>
                </tr>`;
          tbody.innerHTML += row;
        });
      }

      function playMusic(musicId, youtubeId) {
        const userId = 1;
        console.log("음원재생", musicId, youtubeId);

        fetch(`/api/play?musicId=${musicId}&userId=${userId}`, {
          method: 'POST'
        }).then(response => {
          if (response.ok) {
            const iframe = document.getElementById("player");
            iframe.src = `https://www.youtube.com/embed/${youtubeId}?autoplay=1`;
          } else {
            alert("재생 실패");
          }
        });
      }

      window.onload = function () {
        const dateInput = document.getElementById("chartDate");
        const yesterdayStr = getYesterdayDateString();
        dateInput.value = yesterdayStr;
        fetchChart();
      };
    </script>
</head>
<body>
  <h1>일간 차트</h1>
  <input type="date" id="chartDate"/>
  <button onclick="fetchChart()">조회</button>

  <table>
    <thead>
      <tr>
        <th>순위</th>
        <th>제목</th>
        <th>아티스트</th>
        <th>재생수</th>
        <th>재생</th>
      </tr>
    </thead>
    <tbody id="chartBody"></tbody>
  </table>

  <hr>
  <h2>📺 현재 재생 중</h2>
  <iframe id="player" width="560" height="315" src="" frameborder="0"
          allow="autoplay; encrypted-media" allowfullscreen></iframe>

</body>
</html>