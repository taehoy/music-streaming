<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <script th:src="@{/js/auth.js}"></script>
    <script>

        let selectedMusicId = null;

        function playMusic(musicId, youtubeId) {
            const userId = 1; <!-- ì¶”í›„ ë¡œê·¸ì¸ ê¸°ëŠ¥ êµ¬í˜„ ì‹œ ìˆ˜ì • í•„ìš”-->
            console.log("ìŒì›ì¬ìƒ" , musicId, youtubeId)

            // ì¬ìƒ ë¡œê·¸ ì €ì¥
            fetch(`/api/play?musicId=${musicId}&userId=${userId}`, {
                method: 'POST'
            }).then(response => {
                if (response.ok) {
                    const iframe = document.getElementById("player");
                    iframe.src = `https://www.youtube.com/embed/${youtubeId}`;
                } else {
                    alert("ì¬ìƒ ì‹¤íŒ¨");
                }
            });
        }

        function openAddModal(musicId) {
            selectedMusicId = musicId;
            loadPlaylistList();
            document.getElementById("playlistModal").style.display = "block";
        }

        function closeModal() {
            document.getElementById("playlistModal").style.display = "none";
            selectedMusicId = null;
        }

        function addToPlaylist(playlistId) {
            fetch(`/api/playlists/${playlistId}/music`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ musicId: selectedMusicId })
            }).then(res => {
                if (res.ok) {
                    alert("í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ì— ì¶”ê°€ ì™„ë£Œ!");
                } else {
                    alert("ì¶”ê°€ ì‹¤íŒ¨ (ì¤‘ë³µì´ê±°ë‚˜ ì˜¤ë¥˜)");
                }
                closeModal(); // ëª¨ë‹¬ ë‹«ê¸°

                showPlaylistPreview(playlistId); // âœ… ì˜¤ë¥¸ìª½ í”„ë¦¬ë·° ì—´ê¸°
            });
        }

        function createPlaylist() {
            const name = document.getElementById("newPlaylistName").value.trim();
            const userId = 1;

            if (!name) {
                alert("í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.");
                return;
            }

            fetch(`/api/playlists?userId=${userId}&name=${encodeURIComponent(name)}`, {
                method: 'POST'
            }).then(res => {
                if (res.ok) {
                    alert("ìƒì„± ì™„ë£Œ!");
                    document.getElementById("newPlaylistName").value = "";
                    loadPlaylistList(); // ë¦¬ìŠ¤íŠ¸ ë‹¤ì‹œ ë¶ˆëŸ¬ì˜¤ê¸°
                } else {
                    alert("ìƒì„± ì‹¤íŒ¨");
                }
            });
        }

        function loadPlaylistList() {
            const userId = 1;

            fetch(`/api/playlists?userId=${userId}`)
                .then(res => res.json())
                .then(playlists => {
                    const ul = document.getElementById("playlistList");
                    ul.innerHTML = "";

                    playlists.forEach(pl => {
                        const li = document.createElement("li");
                        const btn = document.createElement("button");
                        btn.textContent = pl.name;
                        btn.onclick = () => addToPlaylist(pl.playlistId);
                        li.appendChild(btn);
                        ul.appendChild(li);
                    });
                });
        }

        function showPlaylistPreview(playlistId) {
            fetch(`/api/playlists/${playlistId}`)
                .then(res => res.json())
                .then(data => {
                    // âœ… í”„ë¦¬ë·° ì˜ì—­ í‘œì‹œ
                    document.getElementById("playlistPreviewWrapper").style.display = "block";

                    // ì œëª© ì„¤ì •
                    document.getElementById("previewTitle").textContent = `ğŸµ ${data.name}`;

                    // ëª©ë¡ ë Œë”ë§
                    const ul = document.getElementById("playlistPreviewList");
                    ul.innerHTML = "";

                    data.musics.forEach(song => {
                        const li = document.createElement("li");
                        li.innerHTML = `
                            ${song.title} - ${song.artist}
                            <button onclick="playMusic(${song.musicId}, '${song.youtubeId}')">â–¶ï¸</button>
                            <button onclick="deleteFromPlaylist(${playlistId}, ${song.musicId})">ğŸ—‘ï¸</button>
                        `;
                        ul.appendChild(li);
                    });
                });
        }

        function deleteFromPlaylist(playlistId, musicId) {
            if (!confirm("ì´ ê³¡ì„ í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ì—ì„œ ì‚­ì œí• ê¹Œìš”?")) return;

            fetch(`/api/playlists/${playlistId}/music/${musicId}`, {
                method: 'DELETE'
            }).then(res => {
                if (res.ok) {
                    alert("ì‚­ì œ ì™„ë£Œ!");
                    showPlaylistPreview(playlistId); // ì‚­ì œ í›„ í”„ë¦¬ë·° ê°±ì‹ 
                } else {
                    alert("ì‚­ì œ ì‹¤íŒ¨");
                }
            });
        }

        function closePlaylistPreview() {
            document.getElementById("playlistPreviewWrapper").style.display = "none";
        }
    </script>

    <style>
        #playlistModal {
            display: none;
            position: fixed;
            top: 20%;
            left: 40%;
            background: white;
            border: 1px solid #ccc;
            padding: 20px;
            z-index: 1000;
        }
        #playlistModal button {
            margin: 5px 0;
        }
    </style>
</head>
<body>
    <a href="/posts">ê²Œì‹œíŒ</a>

    <div id="auth-buttons"></div>

    <h1>ì‹¤ì‹œê°„ ì°¨íŠ¸</h1>

    <a href="/chart/daily">
        <button>ğŸ“… ì¼ê°„ ì°¨íŠ¸ ë³´ê¸°</button>
    </a>

    <div style="display: flex; gap: 30px;">
        <!-- ì™¼ìª½: ì‹¤ì‹œê°„ ì°¨íŠ¸ -->
        <div style="flex: 2;">
            <table border="1">
                <thead>
                <tr>
                    <th>ìˆœìœ„</th>
                    <th>ì œëª©</th>
                    <th>ì•„í‹°ìŠ¤íŠ¸</th>
                    <th>ì•¨ë²”</th>
                    <th>ì»¤ë²„</th>
                    <th>ì¬ìƒ</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="music, stat : ${chart}">
                    <td th:text="${stat.index + 1}"></td>
                    <td th:text="${music.title}"></td>
                    <td th:text="${music.artist}"></td>
                    <td th:text="${music.album}"></td>
                    <td><img th:src="${music.coverImageUrl}" width="50"/></td>
                    <td>
                        <button
                                th:if="${music.youtubeUrl != null}"
                                th:attr="onclick=|playMusic(${music.musicId}, '${music.youtubeUrl}')|"
                        >â–¶ï¸ ì¬ìƒ</button>
                        <button
                                th:if="${music.youtubeUrl != null}"
                                th:attr="onclick=|openAddModal(${music.musicId})|"
                        >â•</button>
                    </td>
                </tr>
                </tbody>
            </table>
        </div>

        <!-- ì˜¤ë¥¸ìª½: í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ í”„ë¦¬ë·° -->
        <div id="playlistPreviewWrapper" style="display: none; flex: 1; border-left: 1px solid #ccc; padding-left: 20px;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h3 id="previewTitle">ğŸµ í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ ë¯¸ë¦¬ë³´ê¸°</h3>
                <button onclick="closePlaylistPreview()" style="font-size: 16px;">âŒ</button>
            </div>
            <ul id="playlistPreviewList"></ul>
        </div>
    </div>


    <!-- í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ ëª¨ë‹¬ -->
    <div id="playlistModal">
        <h3>í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ì— ì¶”ê°€</h3>

        <ul id="playlistList"></ul>

        <hr>
        <div>
            <input type="text" id="newPlaylistName" placeholder="ìƒˆ í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ ì´ë¦„" />
            <button onclick="createPlaylist()">â• ìƒˆë¡œ ë§Œë“¤ê¸°</button>
        </div>

        <br>
        <button onclick="closeModal()">ë‹«ê¸°</button>
    </div>

    <hr>
    <h2>ğŸ“º í˜„ì¬ ì¬ìƒ ì¤‘</h2>
    <iframe id="player" width="560" height="315" src="" frameborder="0"
            allow="autoplay; encrypted-media" allowfullscreen></iframe>

    <script>
        function logout() {
            localStorage.removeItem("accessToken");
            window.location.href = "/login";
        }

        function showAuthButtons() {
            const token = localStorage.getItem("accessToken");
            const authDiv = document.getElementById("auth-buttons");

            if (token) {
                // âœ… ë¡œê·¸ì¸ ìƒíƒœ â†’ ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼
                authDiv.innerHTML = `
          <a href="/me.html">ë‚´ ì •ë³´</a>
          <button onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
        `;
            } else {
                // âœ… ë¹„ë¡œê·¸ì¸ ìƒíƒœ â†’ ë¡œê·¸ì¸/íšŒì›ê°€ì… ë²„íŠ¼
                authDiv.innerHTML = `
          <a href="/login">ë¡œê·¸ì¸</a> |
          <a href="/signup">íšŒì›ê°€ì…</a>
        `;
            }
        }

        showAuthButtons();
    </script>
</body>
</html>