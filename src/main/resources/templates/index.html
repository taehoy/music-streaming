<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <script th:src="@{/js/auth.js}"></script>
    <script>

        let selectedMusicId = null;

        function playMusic(musicId, youtubeId) {
            const userId = 1; <!-- 추후 로그인 기능 구현 시 수정 필요-->
            console.log("음원재생" , musicId, youtubeId)

            // 재생 로그 저장
            fetch(`/api/play?musicId=${musicId}&userId=${userId}`, {
                method: 'POST'
            }).then(response => {
                if (response.ok) {
                    const iframe = document.getElementById("player");
                    iframe.src = `https://www.youtube.com/embed/${youtubeId}`;
                } else {
                    alert("재생 실패");
                }
            });
        }

        function openAddModal(musicId) {
            selectedMusicId = musicId;
            const userId = 1;

            fetch(`/api/playlists?userId=${userId}`)
                .then(res => res.json())
                .then(playlists => {
                    const ul = document.getElementById("playlistList");
                    ul.innerHTML = "";

                    playlists.forEach(pl => {
                        const li = document.createElement("li");
                        const btn = document.createElement("button");
                        btn.textContent = pl.name;
                        btn.onclick = () => addToPlaylist(pl.playlistId);
                        li.appendChild(btn);
                        ul.appendChild(li);
                    });

                    document.getElementById("playlistModal").style.display = "block";
                });
        }

        function closeModal() {
            document.getElementById("playlistModal").style.display = "none";
            selectedMusicId = null;
        }

        function addToPlaylist(playlistId) {
            fetch(`/api/playlists/${playlistId}/music`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ musicId: selectedMusicId })
            }).then(res => {
                if (res.ok) {
                    alert("플레이리스트에 추가 완료!");
                    closeModal();
                } else {
                    alert("추가 실패 (중복이거나 오류)");
                }
            });
        }
    </script>

    <style>
        #playlistModal {
            display: none;
            position: fixed;
            top: 20%;
            left: 40%;
            background: white;
            border: 1px solid #ccc;
            padding: 20px;
            z-index: 1000;
        }
        #playlistModal button {
            margin: 5px 0;
        }
    </style>
</head>
<body>
    <a href="/posts">게시판</a>

    <div id="auth-buttons"></div>

    <h1>실시간 차트</h1>

    <a href="/chart/daily">
        <button>📅 일간 차트 보기</button>
    </a>

    <table border="1">
        <thead>
        <tr>
            <th>순위</th>
            <th>제목</th>
            <th>아티스트</th>
            <th>앨범</th>
            <th>커버</th>
            <th>재생</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="music, stat : ${chart}">
            <td th:text="${stat.index + 1}"></td>
            <td th:text="${music.title}"></td>
            <td th:text="${music.artist}"></td>
            <td th:text="${music.album}"></td>
            <td><img th:src="${music.coverImageUrl}" width="50"/></td>
            <td>
                <button
                    th:if="${music.youtubeUrl != null}"
                    th:attr="onclick=|playMusic(${music.musicId}, '${music.youtubeUrl}')|"
                    >▶️ 재생</button>
                <button
                        th:if="${music.youtubeUrl != null}"
                        th:attr="onclick=|openAddModal(${music.musicId})|"
                >➕</button>
            </td>
        </tr>
        </tbody>
    </table>

    <!-- 플레이리스트 모달 -->
    <div id="playlistModal">
        <h3>플레이리스트에 추가</h3>
        <ul id="playlistList"></ul>
        <button onclick="closeModal()">닫기</button>
    </div>

    <hr>
    <h2>📺 현재 재생 중</h2>
    <iframe id="player" width="560" height="315" src="" frameborder="0"
            allow="autoplay; encrypted-media" allowfullscreen></iframe>

    <script>
        function logout() {
            localStorage.removeItem("accessToken");
            window.location.href = "/login";
        }

        function showAuthButtons() {
            const token = localStorage.getItem("accessToken");
            const authDiv = document.getElementById("auth-buttons");

            if (token) {
                // ✅ 로그인 상태 → 로그아웃 버튼
                authDiv.innerHTML = `
          <a href="/me.html">내 정보</a>
          <button onclick="logout()">로그아웃</button>
        `;
            } else {
                // ✅ 비로그인 상태 → 로그인/회원가입 버튼
                authDiv.innerHTML = `
          <a href="/login">로그인</a> |
          <a href="/signup">회원가입</a>
        `;
            }
        }

        showAuthButtons();
    </script>
</body>
</html>