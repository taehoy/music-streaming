<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <script th:src="@{/js/auth.js}"></script>

    <script>
        let selectedMusicId = null;

        let nowPlayingIndex = -1;
        const queue = [];
        let isPlayerReady = false;
        let youtubePlayer;
        function onYouTubeIframeAPIReady() {
            console.log(" Ïú†ÌäúÎ∏å API Ï§ÄÎπÑÎê®")
            youtubePlayer = new YT.Player('youtubePlayer', {
                height: '315',
                width: '560',
                videoId: '',
                events: {
                    'onReady': () => {
                        isPlayerReady = true;
                    },
                    'onStateChange': onPlayerStateChange
                }
            });
        }

        function onPlayerStateChange(event) {
            if (event.data === YT.PlayerState.ENDED) {
                playNextFromQueue();
            }
        }

        function playMusic(musicId, youtubeId, title = null, artist = null) {
            const userId = 1; <!-- Ï∂îÌõÑ Î°úÍ∑∏Ïù∏ Í∏∞Îä• Íµ¨ÌòÑ Ïãú ÏàòÏ†ï ÌïÑÏöî-->
            console.log("ÏùåÏõêÏû¨ÏÉù" , musicId, youtubeId)

            // Ïû¨ÏÉù Î°úÍ∑∏ Ï†ÄÏû•
            fetch(`/api/play?musicId=${musicId}&userId=${userId}`, {
                method: 'POST'
            }).then(response => {
                if (response.ok) {
                    if (isPlayerReady && youtubePlayer && typeof youtubePlayer.loadVideoById === 'function') {
                        youtubePlayer.loadVideoById(youtubeId);
                    } else {
                        alert("Ïú†ÌäúÎ∏å ÌîåÎ†àÏù¥Ïñ¥Í∞Ä ÏïÑÏßÅ Ï§ÄÎπÑÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§.");
                    }

                    // // // Ïû¨ÏÉùÎ™©Î°ù Ï∂îÍ∞Ä
                    // if (title && artist) {
                    //     addToRealtimeQueue(musicId, title, artist, youtubeId);
                    //     nowPlayingIndex = document.querySelectorAll('#realtimeQueue li').length - 1;
                    // }

                    if (title && artist) {
                        // ‚úÖ Ïù¥ÎØ∏ ÏûàÎäî Í≥°Ïù∏ÏßÄ Í≤ÄÏÇ¨
                        const existingIndex = queue.findIndex(q => q.musicId === musicId);
                        if (existingIndex === -1) {
                            queue.push({ musicId, title, artist, youtubeId });
                            nowPlayingIndex = queue.length - 1;
                        } else {
                            nowPlayingIndex = existingIndex;
                        }

                        updateRealtimeQueueUI();
                    }
                } else {
                    alert("Ïû¨ÏÉù Ïã§Ìå®");
                }
            });
        }

        function playNextFromQueue() {
            if (nowPlayingIndex + 1 >= queue.length) {
                console.log("üéµ Ïû¨ÏÉù Î™©Î°ùÏù¥ ÎÅùÎÇ¨ÏäµÎãàÎã§.");
                return;
            }
            nowPlayingIndex++;
            const next = queue[nowPlayingIndex];
            playMusic(next.musicId, next.youtubeId, next.title, next.artist);
        }

        function updateRealtimeQueueUI() {
            const list = document.getElementById("realtimeQueue");
            list.innerHTML = '';
            queue.forEach((item, idx) => {
                const li = document.createElement("li");
                li.innerHTML = `
                ${item.title} - ${item.artist}
                <button onclick="playMusic(${item.musicId}, '${item.youtubeId}', '${item.title}', '${item.artist}')">‚ñ∂Ô∏è</button>
                <button onclick="removeFromRealtimeQueue(${idx})">üóëÔ∏è</button>
            `;
                list.appendChild(li);
            });
        }


        function openAddModal(musicId) {
            selectedMusicId = musicId;
            loadPlaylistList();
            document.getElementById("playlistModal").style.display = "block";
        }

        function closeModal() {
            document.getElementById("playlistModal").style.display = "none";
            selectedMusicId = null;
        }

        function addToPlaylist(playlistId) {
            fetch(`/api/playlists/${playlistId}/music`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ musicId: selectedMusicId })
            }).then(res => {
                if (res.ok) {
                    alert("ÌîåÎ†àÏù¥Î¶¨Ïä§Ìä∏Ïóê Ï∂îÍ∞Ä ÏôÑÎ£å!");
                } else {
                    alert("Ï∂îÍ∞Ä Ïã§Ìå® (Ï§ëÎ≥µÏù¥Í±∞ÎÇò Ïò§Î•ò)");
                }
                closeModal(); // Î™®Îã¨ Îã´Í∏∞

                showPlaylistPreview(playlistId); // ‚úÖ Ïò§Î•∏Ï™Ω ÌîÑÎ¶¨Î∑∞ Ïó¥Í∏∞
            });
        }

        function createPlaylist() {
            const name = document.getElementById("newPlaylistName").value.trim();
            const userId = 1;

            if (!name) {
                alert("ÌîåÎ†àÏù¥Î¶¨Ïä§Ìä∏ Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî.");
                return;
            }

            fetch(`/api/playlists?userId=${userId}&name=${encodeURIComponent(name)}`, {
                method: 'POST'
            }).then(res => {
                if (res.ok) {
                    alert("ÏÉùÏÑ± ÏôÑÎ£å!");
                    document.getElementById("newPlaylistName").value = "";
                    loadPlaylistList(); // Î¶¨Ïä§Ìä∏ Îã§Ïãú Î∂àÎü¨Ïò§Í∏∞
                } else {
                    alert("ÏÉùÏÑ± Ïã§Ìå®");
                }
            });
        }

        function loadPlaylistList() {
            const userId = 1;

            fetch(`/api/playlists?userId=${userId}`)
                .then(res => res.json())
                .then(playlists => {
                    const ul = document.getElementById("playlistList");
                    ul.innerHTML = "";

                    playlists.forEach(pl => {
                        const li = document.createElement("li");
                        const btn = document.createElement("button");
                        btn.textContent = pl.name;
                        btn.onclick = () => addToPlaylist(pl.playlistId);
                        li.appendChild(btn);
                        ul.appendChild(li);
                    });
                });
        }

        function showPlaylistPreview(playlistId) {
            fetch(`/api/playlists/${playlistId}`)
                .then(res => res.json())
                .then(data => {
                    // ‚úÖ ÌîÑÎ¶¨Î∑∞ ÏòÅÏó≠ ÌëúÏãú
                    document.getElementById("playlistPreviewWrapper").style.display = "block";

                    // Ï†úÎ™© ÏÑ§Ï†ï
                    document.getElementById("previewTitle").textContent = `üéµ ${data.name}`;

                    // Î™©Î°ù Î†åÎçîÎßÅ
                    const ul = document.getElementById("playlistPreviewList");
                    ul.innerHTML = "";

                    data.musics.forEach(song => {
                        const li = document.createElement("li");
                        li.innerHTML = `
                            ${song.title} - ${song.artist}
                            <button onclick="playMusic(${song.musicId}, '${song.youtubeId}', '${song.title}', '${song.artist}')">‚ñ∂Ô∏è</button>
                            <button onclick="deleteFromPlaylist(${playlistId}, ${song.musicId})">üóëÔ∏è</button>
                        `;
                        ul.appendChild(li);
                    });
                });
        }

        function deleteFromPlaylist(playlistId, musicId) {
            if (!confirm("Ïù¥ Í≥°ÏùÑ ÌîåÎ†àÏù¥Î¶¨Ïä§Ìä∏ÏóêÏÑú ÏÇ≠Ï†úÌï†ÍπåÏöî?")) return;

            fetch(`/api/playlists/${playlistId}/music/${musicId}`, {
                method: 'DELETE'
            }).then(res => {
                if (res.ok) {
                    alert("ÏÇ≠Ï†ú ÏôÑÎ£å!");
                    showPlaylistPreview(playlistId); // ÏÇ≠Ï†ú ÌõÑ ÌîÑÎ¶¨Î∑∞ Í∞±Ïã†
                } else {
                    alert("ÏÇ≠Ï†ú Ïã§Ìå®");
                }
            });
        }

        function closePlaylistPreview() {
            document.getElementById("playlistPreviewWrapper").style.display = "none";
        }

        function searchMusic() {
            const keyword = document.getElementById("keywordInput").value.trim();
            if (!keyword) return;

            fetch(`/api/music/search?keyword=${encodeURIComponent(keyword)}`)
                .then(res => res.json())
                .then(musicList => {
                    const tbody = document.getElementById("searchResultsBody");
                    tbody.innerHTML = "";

                    if (musicList.length === 0) {
                        document.getElementById("searchResultsTable").style.display = "none";
                        alert("Í≤ÄÏÉâ Í≤∞Í≥ºÍ∞Ä ÏóÜÏäµÎãàÎã§.");
                        return;
                    }

                    document.getElementById("searchResultsTable").style.display = "table";

                    musicList.forEach(music => {
                        const row = document.createElement("tr");
                        row.innerHTML = `
                  <td>${music.title}</td>
                  <td>${music.artist}</td>
                  <td>${music.album}</td>
                  <td><img src="${music.coverImageUrl}" width="50"/></td>
                  <td><button onclick="playMusic(${music.musicId}, '${music.youtubeUrl}', '${music.title}', '${music.artist}')">‚ñ∂Ô∏è</button></td>
                  <td><button onclick="openAddModal(${music.musicId})">‚ûï</button></td>
              `;
                        tbody.appendChild(row);
                    });
                });
        }

        function addToRealtimeQueue(musicId, title, artist, youtubeId) {
            const queue = document.getElementById("realtimeQueue");

            const li = document.createElement("li");

            li.innerHTML = `
                ${title} - ${artist}
                <button onclick="playMusic(${musicId}, '${youtubeId}', '${title}', '${artist}')">‚ñ∂Ô∏è</button>
                <button onclick="removeFromRealtimeQueue(this)">üóëÔ∏è</button>
            `;
            queue.appendChild(li);
        }

        function removeFromRealtimeQueue(index) {
            queue.splice(index, 1);
            if (nowPlayingIndex >= index) nowPlayingIndex--;
            updateRealtimeQueueUI();
        }
    </script>

    <style>
        #playlistModal {
            display: none;
            position: fixed;
            top: 20%;
            left: 40%;
            background: white;
            border: 1px solid #ccc;
            padding: 20px;
            z-index: 1000;
        }
        #playlistModal button {
            margin: 5px 0;
        }

        body {
            margin: 0;
            font-family: sans-serif;
            display: flex;
        }

        /* ÏôºÏ™Ω ÏÇ¨Ïù¥ÎìúÎ∞î */
        #sideNav {
            width: 160px;
            background-color: #f4f4f4;
            border-right: 1px solid #ccc;
            padding: 20px;
            box-sizing: border-box;
            height: 100vh;
            position: fixed;
            display: flex;
            flex-direction: column;
            gap: 20px;
            z-index: 1000;
        }

        #sideNav button,
        #sideNav input {
            width: 100%;
            font-size: 14px;
            padding: 8px;
            margin-bottom: 8px;
            box-sizing: border-box;
        }

        #sideNav input[type="text"] {
            border: 1px solid #ccc;
        }

        /* Ïò§Î•∏Ï™Ω Î≥∏Î¨∏ */
        #mainContent {
            margin-left: 160px;
            padding: 20px;
            width: 100%;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        th, td {
            border-bottom: 1px solid #ddd;
            padding: 10px;
            text-align: center;
        }

        img {
            border-radius: 4px;
        }
    </style>
</head>
<body>
<div style="display: flex; min-height: 100vh;">
    <!-- ‚úÖ ÏôºÏ™Ω ÏÇ¨Ïù¥ÎìúÎ∞î -->
    <nav id="sideNav">
        <form id="searchForm" onsubmit="event.preventDefault(); searchMusic();">
            <input type="text" id="keywordInput" placeholder="üîç Í≤ÄÏÉâÏñ¥ ÏûÖÎ†•">
            <button type="submit">Í≤ÄÏÉâ</button>
        </form>
        <button onclick="location.href='/'">üè† Ìôà</button>
        <button onclick="location.href='/me/playlists'">üìã ÎßàÏù¥ÌéòÏù¥ÏßÄ</button>
        <button onclick="location.href='/chart/daily'">üìÖ ÏùºÍ∞ÑÏ∞®Ìä∏</button>
    </nav>

    <!-- ‚úÖ Ïò§Î•∏Ï™Ω Î≥∏Î¨∏ ÏòÅÏó≠ -->
    <main id="mainContent">

        <!-- üîç Í≤ÄÏÉâ Í≤∞Í≥º ÌÖåÏù¥Î∏î -->
        <h2>üîç Í≤ÄÏÉâ Í≤∞Í≥º</h2>
        <table id="searchResultsTable" style="display: none;">
            <thead>
            <tr>
                <th>Ï†úÎ™©</th>
                <th>ÏïÑÌã∞Ïä§Ìä∏</th>
                <th>Ïï®Î≤î</th>
                <th>Ïª§Î≤Ñ</th>
                <th>Ïû¨ÏÉù</th>
                <th>Ï∂îÍ∞Ä</th>
            </tr>
            </thead>
            <tbody id="searchResultsBody">
            <!-- JSÎ°ú Ï±ÑÏõåÏßê -->
            </tbody>
        </table>
        <!-- Í∏∞Ï°¥ ÎÇ¥Ïö© Ïó¨Í∏∞Ïóê ÏúÑÏπò -->
        <a href="/posts">Í≤åÏãúÌåê</a>

        <div id="auth-buttons"></div>

        <h1>Ïã§ÏãúÍ∞Ñ Ï∞®Ìä∏</h1>

        <a href="/chart/daily">
            <button>üìÖ ÏùºÍ∞Ñ Ï∞®Ìä∏ Î≥¥Í∏∞</button>
        </a>

        <div style="display: flex; gap: 30px;">
            <!-- ÏôºÏ™Ω: Ïã§ÏãúÍ∞Ñ Ï∞®Ìä∏ -->
            <div style="flex: 2;">
                <table border="1">
                    <thead>
                    <tr>
                        <th>ÏàúÏúÑ</th>
                        <th>Ï†úÎ™©</th>
                        <th>ÏïÑÌã∞Ïä§Ìä∏</th>
                        <th>Ïï®Î≤î</th>
                        <th>Ïª§Î≤Ñ</th>
                        <th>Ïû¨ÏÉù</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:each="music, stat : ${chart}">
                        <td th:text="${stat.index + 1}"></td>
                        <td th:text="${music.title}"></td>
                        <td th:text="${music.artist}"></td>
                        <td th:text="${music.album}"></td>
                        <td><img th:src="${music.coverImageUrl}" width="50"/></td>
                        <td>
                            <button
                                    th:if="${music.youtubeUrl != null}"
                                    th:attr="onclick=|playMusic(${music.musicId}, '${music.youtubeUrl}', '${music.title}', '${music.artist}')|"
                            >‚ñ∂Ô∏è Ïû¨ÏÉù</button>
                            <button
                                    th:if="${music.youtubeUrl != null}"
                                    th:attr="onclick=|openAddModal(${music.musicId})|"
                            >‚ûï</button>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>

            <!-- Ïò§Î•∏Ï™Ω: ÌîåÎ†àÏù¥Î¶¨Ïä§Ìä∏ ÌîÑÎ¶¨Î∑∞ -->
            <div id="playlistPreviewWrapper" style="display: none; flex: 1; border-left: 1px solid #ccc; padding-left: 20px;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <h3 id="previewTitle">üéµ ÌîåÎ†àÏù¥Î¶¨Ïä§Ìä∏ ÎØ∏Î¶¨Î≥¥Í∏∞</h3>
                    <button onclick="closePlaylistPreview()" style="font-size: 16px;">‚ùå</button>
                </div>
                <ul id="playlistPreviewList"></ul>
            </div>

            <!-- ‚úÖ Ïò§Î•∏Ï™Ω: Ïã§ÏãúÍ∞Ñ Ïû¨ÏÉù Î™©Î°ù -->
            <div id="realtimeQueueWrapper" style="display: block; flex: 1; border-left: 1px solid #ccc; padding-left: 20px;">
                <h3>üéß Ïã§ÏãúÍ∞Ñ Ïû¨ÏÉù Î™©Î°ù</h3>
                <ul id="realtimeQueue"></ul>
            </div>
        </div>


        <!-- ÌîåÎ†àÏù¥Î¶¨Ïä§Ìä∏ Î™®Îã¨ -->
        <div id="playlistModal">
            <h3>ÌîåÎ†àÏù¥Î¶¨Ïä§Ìä∏Ïóê Ï∂îÍ∞Ä</h3>

            <ul id="playlistList"></ul>

            <hr>
            <div>
                <input type="text" id="newPlaylistName" placeholder="ÏÉà ÌîåÎ†àÏù¥Î¶¨Ïä§Ìä∏ Ïù¥Î¶Ñ" />
                <button onclick="createPlaylist()">‚ûï ÏÉàÎ°ú ÎßåÎì§Í∏∞</button>
            </div>

            <br>
            <button onclick="closeModal()">Îã´Í∏∞</button>
        </div>

        <hr>
        <h2>üì∫ ÌòÑÏû¨ Ïû¨ÏÉù Ï§ë</h2>
        <div id="playerContainer">
            <div id="youtubePlayer"></div>
        </div>
<!--        <iframe id="player" width="560" height="315" src="" frameborder="0"-->
<!--                allow="autoplay; encrypted-media" allowfullscreen></iframe>-->
    </main>
</div>
    <script src="https://www.youtube.com/iframe_api"></script>

    <script>
        function logout() {
            localStorage.removeItem("accessToken");
            window.location.href = "/login";
        }

        function showAuthButtons() {
            const token = localStorage.getItem("accessToken");
            const authDiv = document.getElementById("auth-buttons");

            if (token) {
                // ‚úÖ Î°úÍ∑∏Ïù∏ ÏÉÅÌÉú ‚Üí Î°úÍ∑∏ÏïÑÏõÉ Î≤ÑÌäº
                authDiv.innerHTML = `
          <a href="/me.html">ÎÇ¥ Ï†ïÎ≥¥</a>
          <button onclick="logout()">Î°úÍ∑∏ÏïÑÏõÉ</button>
        `;
            } else {
                // ‚úÖ ÎπÑÎ°úÍ∑∏Ïù∏ ÏÉÅÌÉú ‚Üí Î°úÍ∑∏Ïù∏/ÌöåÏõêÍ∞ÄÏûÖ Î≤ÑÌäº
                authDiv.innerHTML = `
          <a href="/login">Î°úÍ∑∏Ïù∏</a> |
          <a href="/signup">ÌöåÏõêÍ∞ÄÏûÖ</a>
        `;
            }
        }

        showAuthButtons();
    </script>
</body>
</html>